<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Predicciones UFC</title>
  
  <nav style="background:#111; padding:10px; text-align:center;">
    <a href="stats.html" style="color:white; margin:0 15px;">üìä Estad√≠sticas</a>
    <a href="historial.html" style="color:white; margin:0 15px;">üìÅ Historial</a>
  </nav>

  <style>
    body { font-family: Arial, sans-serif; background: #f2f2f2; margin: 20px; }
    h1, h2 { text-align: center; }
    .fight, .login-box, .panel-box, .admin-box, .ranking-box { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; }
    label { margin-right: 15px; }
    .section { max-width: 800px; margin: auto; }
    .submit-btn { display: block; margin: 20px auto; padding: 10px 20px; font-size: 16px; }
    .method { margin-top: 10px; }
    .hidden { display: none; }
    input[type="text"], input[type="password"], select {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    .acierto { background-color: #d4edda; }
    .fallo { background-color: #f8d7da; }
  </style>
</head>
<body>
  <h1>Predicciones UFC</h1>

  <div class="section" id="login-section">
    <div class="login-box">
      <h2>Iniciar sesi√≥n</h2>
      <label for="username">Usuario:</label>
      <input type="text" id="username">
      <label for="password">Contrase√±a:</label>
      <input type="password" id="password">
      <label for="event-selector">Selecciona evento:</label>
      <select id="event-selector">
        <option value="ufc304">UFC 304 - Whittaker vs de Ridder</option>
        <option value="ufcApex108">UFC Apex 108 - Taira vs Park</option>
        <option value="ufcApex109">UFC Apex 109 - Dolidze vs Hernandez</option>
      </select>
      <button onclick="login()">Entrar</button>
      <button onclick="localStorage.clear(); alert('Datos borrados'); location.reload();" style="margin-top: 10px;">üîÑ Borrar LocalStorage</button>
    </div>
  </div>

  <div class="section hidden" id="prediction-section">
    <h2 id="welcome-user"></h2>
    <div id="fight-list"></div>
    <button class="submit-btn" id="submit-btn" onclick="submitPredictions()">Enviar Predicciones</button>
  </div>

  <div class="section hidden" id="panel-section">
    <div class="panel-box">
      <h2>Predicciones guardadas</h2>
      <div id="no-predictions" style="text-align:center; display:none; color:#a00">No hay predicciones guardadas.</div>
      <table id="prediction-table" style="display:none;">
        <thead>
          <tr><th>Pelea</th><th>Tipo</th><th>Ganador</th><th>M√©todo</th><th>Puntos</th><th>‚úîÔ∏è</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <h3 style="text-align:center">Total de puntos: <span id="total-points">0</span></h3>
      <h3 style="text-align:center">Aciertos: <span id="aciertos">0</span> / <span id="total-pelea">0</span> (<span id="porcentaje">0</span>%)</h3>
    </div>
  </div>

  <div class="section hidden" id="admin-section">
    <div class="admin-box">
      <h2>Panel Administrador - Confirmar Resultados</h2>
      <div id="admin-fight-list"></div>
      <button class="submit-btn" onclick="saveResults()">Guardar Resultados</button>
      <button class="submit-btn" onclick="showRanking()">Ver Ranking de Jugadores</button>
    </div>
  </div>

  <div class="section hidden" id="ranking-section">
    <div class="ranking-box">
      <h2>Ranking de Jugadores</h2>
      <table>
        <thead>
          <tr><th>Jugador</th><th>Puntos Totales</th></tr>
        </thead>
        <tbody id="ranking-body"></tbody>
      </table>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyASAZyQrO2m03A46_gILD_tyUenkRn3HXA",
      authDomain: "prediccionesufc.firebaseapp.com",
      projectId: "prediccionesufc",
      storageBucket: "prediccionesufc.appspot.com",
      messagingSenderId: "372069968923",
      appId: "1:372069968923:web:cba4dc58e880214dc49cbe",
      databaseURL: "https://prediccionesufc-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);

        const db = firebase.firestore();
    const rtdb = firebase.database();

    const users = {
      "david": "clave",
      "esteban": "lebron",
      "cabas": "curry13",
      "pingon": "pinga",
      "admin": "1"
    };

    const eventos = {
      ufc304: {
        nombre: "UFC 304 - Whittaker vs de Ridder",
        peleas: [
          { id: "1", nombre: "Whittaker vs de Ridder", tipo: "Main Card", estelar: true },
          { id: "2", nombre: "Pelea 2", tipo: "Main Card" },
          { id: "3", nombre: "Pelea 3", tipo: "Preliminar" }
        ]
      },
      ufcApex108: {
        nombre: "UFC Apex 108 - Taira vs Park",
        peleas: [
          { id: "1", nombre: "Taira vs Park", tipo: "Main Card", estelar: true },
          { id: "2", nombre: "Pelea 2", tipo: "Main Card" },
          { id: "3", nombre: "Pelea 3", tipo: "Preliminar" }
        ]
      },
      ufcApex109: {
        nombre: "UFC Apex 109 - Dolidze vs Hernandez",
        peleas: [
          { id: "1", nombre: "Dolidze vs Hernandez", tipo: "Main Card", estelar: true },
          { id: "2", nombre: "Pelea 2", tipo: "Main Card" },
          { id: "3", nombre: "Pelea 3", tipo: "Preliminar" }
        ]
      }
    };

    let currentUser = null;
    let currentEvent = null;
    let isAdmin = false;

    function login() {
      const user = document.getElementById("username").value.toLowerCase();
      const pass = document.getElementById("password").value;
      const event = document.getElementById("event-selector").value;

      if (users[user] && users[user] === pass) {
        currentUser = user;
        currentEvent = event;
        isAdmin = user === "admin";

        document.getElementById("login-section").classList.add("hidden");

        document.getElementById("welcome-user").innerText = `Bienvenido, ${user} | ${eventos[event].nombre}`;

        if (isAdmin) {
          document.getElementById("admin-section").classList.remove("hidden");
          renderAdminPanel();
        } else {
          document.getElementById("prediction-section").classList.remove("hidden");
          db.collection("predicciones").doc(`${user}_${event}`).get().then(doc => {
            if (doc.exists) {
              document.getElementById("submit-btn").style.display = "none";
              showPanel();
            } else {
              renderFights();
            }
          });
        }
      } else {
        alert("Usuario o contrase√±a incorrectos");
      }
    }

    function renderFights() {
      const container = document.getElementById("fight-list");
      container.innerHTML = '';
      const fights = eventos[currentEvent].peleas;

      fights.forEach(f => {
        const div = document.createElement("div");
        div.classList.add("fight");
        div.innerHTML = `<strong>${f.nombre}</strong><br>
          <label><input type="radio" name="fight_${f.id}" value="1"> Luchador A</label>
          <label><input type="radio" name="fight_${f.id}" value="2"> Luchador B</label>`;

        if (f.tipo === 'Main Card') {
          div.innerHTML += `
            <div class="method">
              <label>M√©todo de victoria:</label>
              <select id="method_${f.id}">
                <option value="">Selecciona...</option>
                <option value="KO">KO</option>
                <option value="SUB">SUB</option>
                <option value="DEC">DEC</option>
              </select>
            </div>`;
        }

        container.appendChild(div);
      });
    }

    async function submitPredictions() {
      const predictions = [];
      const fights = eventos[currentEvent].peleas;

      for (let f of fights) {
        const sel = document.querySelector(`input[name=fight_${f.id}]:checked`);
        if (!sel) return alert("Debes completar todas las predicciones antes de enviarlas.");

        const ganador = sel.value;
        let metodo = null;
        if (f.estelar === true || f.tipo === "Main Card") {
          metodo = document.getElementById(`method_${f.id}`).value;
          if (!metodo) return alert(`Selecciona el m√©todo de victoria para la pelea "${f.nombre}".`);
        }

        predictions.push({
          pelea: f.nombre,
          tipo: f.tipo,
          ganador,
          metodo,
          estelar: f.estelar || false
        });
      }

      try {
        await db.collection("predicciones").doc(`${currentUser}_${currentEvent}`).set({
          usuario: currentUser,
          evento: currentEvent,
          predicciones: predictions
        });
        alert("Predicciones guardadas correctamente.");
        document.getElementById("submit-btn").style.display = "none";
        showPanel();
      } catch (e) {
        console.error("Error al guardar en Firestore:", e);
        alert("Hubo un problema al guardar. Intenta de nuevo.");
      }
    }
    
        async function showPanel() {
      const predSnap = await db.collection("predicciones").doc(`${currentUser}_${currentEvent}`).get();
      const resSnap = await db.collection("resultados").doc(currentEvent).get();
      const predData = predSnap.exists ? predSnap.data().predicciones : [];
      const resultados = resSnap.exists ? resSnap.data() : {};

      let html = `<table><thead>
        <tr><th>Pelea</th><th>Tu Predicci√≥n</th><th>M√©todo</th><th>Ganador Real</th><th>M√©todo Real</th><th>‚úîÔ∏è</th></tr>
      </thead><tbody>`;

      let aciertos = 0;
      let puntos = 0;

      for (let p of predData) {
        const resultado = resultados[p.pelea];
        const gano = resultado && resultado.ganador == p.ganador;
        const metodoOk = resultado && resultado.metodo?.toLowerCase().trim() === (p.metodo || '').toLowerCase().trim();

        let puntosPelea = 0;
        if (gano) {
          aciertos++;
          if (p.tipo === "Preliminar") puntosPelea = 1;
          else if (p.tipo === "Main Card") {
            puntosPelea = 2;
            if (p.estelar && metodoOk) puntosPelea += 1;
          }
        }

        puntos += puntosPelea;
        const acierto = gano ? (metodoOk ? '‚úÖ‚úÖ' : '‚úÖ') : '‚ùå';
        const clase = gano ? 'acierto' : 'fallo';

        html += `<tr class="${clase}">
          <td>${p.pelea}</td>
          <td>${p.ganador}</td>
          <td>${p.metodo || '-'}</td>
          <td>${resultado?.ganador || '-'}</td>
          <td>${resultado?.metodo || '-'}</td>
          <td>${acierto}</td>
        </tr>`;
      }

      html += `</tbody></table><br><p><strong>Total aciertos:</strong> ${aciertos}<br><strong>Puntos:</strong> ${puntos}</p>`;
      const container = document.getElementById("fight-list");
      container.innerHTML = html;
    }

    async function renderAdminPanel() {
      const container = document.getElementById("admin-results");
      container.innerHTML = '';
      const fights = eventos[currentEvent].peleas;

      fights.forEach(f => {
        const div = document.createElement("div");
        div.classList.add("fight");
        div.innerHTML = `
          <strong>${f.nombre}</strong><br>
          <label><input type="radio" name="res_${f.id}" value="1"> Luchador A</label>
          <label><input type="radio" name="res_${f.id}" value="2"> Luchador B</label><br>
          <label>M√©todo:</label>
          <select id="resmetodo_${f.id}">
            <option value="">Selecciona...</option>
            <option value="KO">KO</option>
            <option value="SUB">SUB</option>
            <option value="DEC">DEC</option>
          </select>
        `;
        container.appendChild(div);
      });
    }

    async function guardarResultados() {
      const fights = eventos[currentEvent].peleas;
      const resultados = {};

      for (let f of fights) {
        const ganador = document.querySelector(`input[name=res_${f.id}]:checked`);
        const metodo = document.getElementById(`resmetodo_${f.id}`).value;
        if (!ganador || !metodo) return alert(`Falta completar ${f.nombre}`);
        resultados[f.nombre] = { ganador: ganador.value, metodo };
      }

      try {
        await db.collection("resultados").doc(currentEvent).set(resultados);
        alert("Resultados guardados");
      } catch (e) {
        console.error("Error guardando resultados:", e);
        alert("Error al guardar resultados");
      }
    }
</script>

</body>
</html>
