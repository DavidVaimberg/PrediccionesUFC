<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Estadísticas Globales UFC</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 20px; }
    h1, h2 { text-align: center; }
    .table-box { background: #fff; padding: 20px; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #eaeaea; }
  </style>
</head>
<body>
  <h1>Estadísticas Globales de Usuarios</h1>

  <div class="table-box">
    <h2>Puntos Totales</h2>
    <table id="tabla-puntos">
      <thead><tr><th>Usuario</th><th>Puntos</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-box">
    <h2>Peleas Acertadas</h2>
    <table id="tabla-aciertos">
      <thead><tr><th>Usuario</th><th>Aciertos</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-box">
    <h2>Porcentaje de Acierto</h2>
    <table id="tabla-porcentaje">
      <thead><tr><th>Usuario</th><th>% Acierto</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyASAZyQrO2m03A46_gILD_tyUenkRn3HXA",
    authDomain: "prediccionesufc.firebaseapp.com",
    projectId: "prediccionesufc",
    storageBucket: "prediccionesufc.appspot.com",
    messagingSenderId: "372069968923",
    appId: "1:372069968923:web:cba4dc58e880214dc49cbe"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const eventos = ["ufc304", "ufcApex108", "ufcApex109"];
  const estadisticas = {};
  const usuariosSet = new Set();

  async function cargarEstadisticas() {
    // 1. Carga todas las predicciones de todos los usuarios
    const predSnap = await db.collection("predicciones").get();
    const prediccionesPorUsuario = {};

    predSnap.forEach(doc => {
      const data = doc.data();
      const { usuario, evento, predicciones } = data;

      usuariosSet.add(usuario);

      if (!prediccionesPorUsuario[usuario]) {
        prediccionesPorUsuario[usuario] = [];
      }

      prediccionesPorUsuario[usuario].push({ evento, predicciones });
    });

    // 2. Calcula estadísticas por usuario
    for (const usuario of usuariosSet) {
      let totalPuntos = 0;
      let aciertos = 0;
      let totalPeleas = 0;

      const registros = prediccionesPorUsuario[usuario] || [];

      for (const { evento, predicciones } of registros) {
        const resSnap = await db.collection("resultados").doc(evento).get();
        const resultados = resSnap.exists ? resSnap.data() : {};

        for (const p of predicciones) {
          totalPeleas++;
          const r = resultados[p.pelea];
          if (r && String(r.ganador) === String(p.ganador)) {
            aciertos++;
            if (p.tipo === 'Preliminar') totalPuntos += 1;
            else if (p.tipo === 'Main Card' && p.estelar === true) {
              totalPuntos += 2;
              if (r.metodo?.toLowerCase().trim() === (p.metodo || '').toLowerCase().trim()) {
                totalPuntos += 1;
              }
            } else {
              totalPuntos += 2;
            }
          }
        }
      }

      estadisticas[usuario] = {
        puntos: totalPuntos,
        aciertos,
        porcentaje: totalPeleas ? ((aciertos / totalPeleas) * 100).toFixed(1) : "0.0"
      };
    }

    renderizarTablas();
  }

  function renderizarTablas() {
    const puntosBody = document.querySelector("#tabla-puntos tbody");
    const aciertosBody = document.querySelector("#tabla-aciertos tbody");
    const porcentajeBody = document.querySelector("#tabla-porcentaje tbody");

    puntosBody.innerHTML = "";
    aciertosBody.innerHTML = "";
    porcentajeBody.innerHTML = "";

    Object.entries(estadisticas).forEach(([user, stats]) => {
      puntosBody.innerHTML += `<tr><td>${user}</td><td>${stats.puntos}</td></tr>`;
      aciertosBody.innerHTML += `<tr><td>${user}</td><td>${stats.aciertos}</td></tr>`;
      porcentajeBody.innerHTML += `<tr><td>${user}</td><td>${stats.porcentaje}%</td></tr>`;
    });
  }

  cargarEstadisticas();
</script>

</body>
</html>
