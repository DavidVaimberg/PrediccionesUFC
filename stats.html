<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Estadísticas Globales UFC</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 20px; }
    h1, h2 { text-align: center; }
    .table-box { background: #fff; padding: 20px; margin-bottom: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background-color: #eaeaea; }
  </style>
</head>
<body>
  <h1>Estadísticas Globales de Usuarios</h1>

  <div class="table-box">
    <h2>Puntos Totales</h2>
    <table id="tabla-puntos">
      <thead><tr><th>Usuario</th><th>Puntos</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-box">
    <h2>Peleas Acertadas</h2>
    <table id="tabla-aciertos">
      <thead><tr><th>Usuario</th><th>Aciertos</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="table-box">
    <h2>Porcentaje de Acierto</h2>
    <table id="tabla-porcentaje">
      <thead><tr><th>Usuario</th><th>% Acierto</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyASAZyQrO2m03A46_gILD_tyUenkRn3HXA",
      authDomain: "prediccionesufc.firebaseapp.com",
      projectId: "prediccionesufc",
      storageBucket: "prediccionesufc.appspot.com",
      messagingSenderId: "372069968923",
      appId: "1:372069968923:web:cba4dc58e880214dc49cbe"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const usuarios = {};
    const eventosEstelares = {};  // Almacena info sobre qué peleas son estelares

    async function cargarEstadisticas() {
      const predSnap = await db.collection("predicciones").get();

      for (const doc of predSnap.docs) {
        const { usuario, evento, predicciones } = doc.data();
        if (!usuario || !Array.isArray(predicciones)) continue;

        if (!usuarios[usuario]) {
          usuarios[usuario] = { puntos: 0, aciertos: 0, totales: 0 };
        }

        const resSnap = await db.collection("resultados").doc(evento).get();
        const resultados = resSnap.exists ? resSnap.data() : {};

        for (const p of predicciones) {
          usuarios[usuario].totales++;

          const res = resultados[p.pelea];
          if (!res) continue;

          const acertado = String(res.ganador) === String(p.ganador);
          const metodoOk = res.metodo?.toLowerCase().trim() === (p.metodo || '').toLowerCase().trim();

          if (acertado) {
            usuarios[usuario].aciertos++;

            if (p.tipo === "Preliminar") {
              usuarios[usuario].puntos += 1;
            } else if (p.tipo === "Main Card") {
              usuarios[usuario].puntos += 2;
              if (p.estelar === true && metodoOk) {
                usuarios[usuario].puntos += 1;
              }
            }
          }
        }
      }

      renderizarTablas();
    }

    function renderizarTablas() {
      const puntosBody = document.querySelector("#tabla-puntos tbody");
      const aciertosBody = document.querySelector("#tabla-aciertos tbody");
      const porcentajeBody = document.querySelector("#tabla-porcentaje tbody");

      puntosBody.innerHTML = "";
      aciertosBody.innerHTML = "";
      porcentajeBody.innerHTML = "";

      Object.entries(usuarios).forEach(([nombre, stats]) => {
        const { puntos, aciertos, totales } = stats;
        const porcentaje = totales > 0 ? ((aciertos / totales) * 100).toFixed(1) : "0.0";

        puntosBody.innerHTML += `<tr><td>${nombre}</td><td>${puntos}</td></tr>`;
        aciertosBody.innerHTML += `<tr><td>${nombre}</td><td>${aciertos}</td></tr>`;
        porcentajeBody.innerHTML += `<tr><td>${nombre}</td><td>${porcentaje}%</td></tr>`;
      });
    }

    cargarEstadisticas();
  </script>
</body>
</html>
