<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Historial de Predicciones</title>
  <nav style="background:#111; padding:10px; text-align:center;">
    <a href="index.html" style="color:white; margin:0 15px;">Inicio</a>
    <a href="stats.html" style="color:white; margin:0 15px;">üìä Estad√≠sticas</a>
  </nav>
  <style>
    body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
    h1, h2 { text-align: center; }
    .content { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
    select { font-size: 16px; padding: 5px; margin-bottom: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #eee; }
    .acierto { background-color: #d4edda; }
    .fallo { background-color: #f8d7da; }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
</head>
<body>
  <div class="content">
    <h1>Historial de Predicciones</h1>

    <label for="evento-select">Selecciona un evento:</label>
    <select id="evento-select"></select>

    <div id="tabla-container"></div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyASAZyQrO2m03A46_gILD_tyUenkRn3HXA",
  authDomain: "prediccionesufc.firebaseapp.com",
  projectId: "prediccionesufc",
  storageBucket: "prediccionesufc.appspot.com",
  messagingSenderId: "372069968923",
  appId: "1:372069968923:web:cba4dc58e880214dc49cbe"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const eventos = {
  ufc304: "UFC 304 - Whittaker vs de Ridder",
  ufcApex108: "UFC Apex 108 - Taira vs Park",
  ufcApex109: "UFC Apex 109 - Dolidze vs Hernandez"
};

const selector = document.getElementById("evento-select");
Object.entries(eventos).forEach(([key, name]) => {
  const opt = document.createElement("option");
  opt.value = key;
  opt.textContent = name;
  selector.appendChild(opt);
});

selector.addEventListener("change", mostrarHistorial);
window.addEventListener("DOMContentLoaded", () => {
  selector.value = Object.keys(eventos)[0];
  mostrarHistorial();
});

async function mostrarHistorial() {
  const evento = selector.value;
  const container = document.getElementById("tabla-container");
  container.innerHTML = "<p>Cargando...</p>";

  const predSnap = await db.collection("predicciones").where("evento", "==", evento).get();
  const resSnap = await db.collection("resultados").doc(evento).get();
  const resultados = resSnap.exists ? resSnap.data() : {};

  let html = '';
  const predPorUsuario = {};

  predSnap.forEach(doc => {
    const { usuario, predicciones } = doc.data();
    if (!predPorUsuario[usuario]) predPorUsuario[usuario] = [];
    predPorUsuario[usuario].push(...predicciones);
  });

  Object.entries(predPorUsuario).forEach(([usuario, predicciones]) => {
    html += `<h2>Usuario: ${usuario}</h2>`;
    html += `<table>
      <thead>
        <tr><th>Pelea</th><th>Predicci√≥n</th><th>M√©todo</th><th>Resultado</th><th>M√©todo Real</th><th>‚úîÔ∏è</th></tr>
      </thead><tbody>`;

    predicciones.forEach(p => {
      const res = resultados[p.pelea];
      const gano = res && String(res.ganador) === String(p.ganador);
      const metodoCorrecto = res?.metodo?.toLowerCase().trim() === (p.metodo || '').toLowerCase().trim();
      const acierto = gano ? (metodoCorrecto ? '‚úÖ‚úÖ' : '‚úÖ') : '‚ùå';

      html += `<tr class="${gano ? 'acierto' : 'fallo'}">
        <td>${p.pelea}</td>
        <td>${p.ganador}</td>
        <td>${p.metodo || '-'}</td>
        <td>${res?.ganador || '-'}</td>
        <td>${res?.metodo || '-'}</td>
        <td>${acierto}</td>
      </tr>`;
    });

    html += `</tbody></table><br>`;
  });

  container.innerHTML = html || '<p>No hay predicciones para este evento.</p>';
}
</script>
</body>
</html>
